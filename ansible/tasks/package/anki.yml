- name: Check anki installed
  shell: command -v anki
  ignore_errors: true
  register: anki_exists
  tags:
    - anki
    - packages

- name: Download and unarchive anki
  when: ansible_system == "Linux" and anki_exists is failed
  unarchive:
    src: https://github.com/ankitects/anki/releases/download/2.1.49/anki-2.1.49-linux.tar.bz2
    dest: "{{ lookup('env', 'HOME') }}/Downloads/"
    remote_src: true
  tags:
    - anki
    - packages

- name: Install Anki
  when: ansible_system == "Linux" and anki_exists is failed
  become: true
  args:
    chdir: "{{ lookup('env', 'HOME') }}/Downloads/anki-2.1.49-linux/"
  shell: "./install.sh"
  tags:
    - anki
    - packages

- name: Edit anki desktop file (blank screen linux fix)
  when: ansible_system == "Linux" and anki_exists
  become: true
  lineinfile:
    path: "/usr/local/share/applications/anki.desktop"
    search_string: 'Exec=anki %f'
    line: 'Exec=env QTWEBENGINE_CHROMIUM_FLAGS="--no-sandbox" anki %f'
    owner: root
    group: root
  tags:
    - anki
    - packages

- name: Remove anki download
  when: ansible_system == "Linux" and anki_exists
  file:
    path: "{{ lookup('env', 'HOME') }}/Downloads/anki-2.1.49-linux/"
    state: absent
  tags:
    - anki
    - packages
